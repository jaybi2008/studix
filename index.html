<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#080810">
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Studix">
<title>Studix</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0a0a0a; --bg1:#111111; --bg2:#181818; --card:#141414;
  --border:rgba(255,255,255,0.07); --border2:rgba(255,255,255,0.15);
  --text:#f0f0f0; --text2:#888888; --text3:#444444;
  --accent:#e0e0e0; --accent2:#ffffff; --ag:rgba(255,255,255,0.08);
  --green:#aaaaaa; --gg:rgba(200,200,200,0.1);
  --orange:#cccccc; --red:#999999;
  --nav:72px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;font-family:'Syne',sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;-webkit-tap-highlight-color:transparent;}
.app{display:flex;flex-direction:column;height:100dvh;max-width:430px;margin:0 auto;position:relative;overflow:hidden;}

/* HEADER */
.hdr{display:flex;align-items:center;justify-content:space-between;padding:50px 20px 12px;flex-shrink:0;}
.logo{font-size:20px;font-weight:800;letter-spacing:-.5px;color:var(--accent2);}
.iabtn{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:500;padding:6px 12px;border-radius:99px;border:1px solid var(--border2);background:var(--card);color:var(--text2);cursor:pointer;transition:all .2s;white-space:nowrap;}
.iabtn.on{border-color:var(--green);color:var(--green);background:var(--gg);}

/* SCROLL */
.scroll{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding:0 16px calc(var(--nav) + 20px);}
.scroll::-webkit-scrollbar{display:none;}

/* PAGES */
.pg{display:none;}
.pg.on{display:block;animation:up .25s ease;}
@keyframes up{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}

/* LABELS */
.lbl{font-size:11px;font-weight:700;letter-spacing:1.8px;text-transform:uppercase;color:var(--text3);margin:20px 0 10px;}
.lbl2{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);margin-bottom:6px;display:block;}

/* CARDS */
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:18px;margin-bottom:10px;}

/* DASHBOARD */
.greet{font-size:30px;font-weight:800;letter-spacing:-1.5px;line-height:1.15;margin-bottom:4px;}
.greet span{color:var(--accent2);}
.gdate{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text2);margin-bottom:20px;}

.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px;}
.sc{background:var(--bg1);border:1px solid var(--border);border-radius:16px;padding:14px 10px;text-align:center;}
.sn{font-size:26px;font-weight:800;letter-spacing:-1px;line-height:1;color:var(--accent2);}
.sl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-top:4px;}

/* DEVOIR ROW */
.drow{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);}
.drow:last-child{border-bottom:none;}
.dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.dr{background:#ff6b6b;box-shadow:0 0 6px #ff6b6b;}
.do{background:#aaaaaa;box-shadow:0 0 6px #aaaaaa;}
.dg{background:#666666;box-shadow:0 0 4px #666666;}
.db{background:#dddddd;box-shadow:0 0 6px #dddddd;}
.di{flex:1;min-width:0;}
.dm{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);}
.dt{font-size:14px;font-weight:600;margin:2px 0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.dd{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text2);}
.iab{padding:5px 11px;border-radius:99px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.06);color:var(--accent2);font-family:'Syne',sans-serif;font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;flex-shrink:0;}
.iab:hover{background:var(--accent2);color:#0a0a0a;}

/* IA PAGE */
.iah{font-size:24px;font-weight:800;letter-spacing:-.8px;margin-bottom:4px;}
.ias{font-size:12px;color:var(--text2);margin-bottom:16px;}
.tabs{display:flex;gap:6px;margin-bottom:16px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;}
.tabs::-webkit-scrollbar{display:none;}
.tab{flex-shrink:0;padding:7px 15px;border-radius:99px;border:1px solid var(--border2);background:transparent;color:var(--text2);font-family:'Syne',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;}
.tab.on{background:var(--accent2);border-color:var(--accent2);color:#0a0a0a;box-shadow:0 0 16px var(--ag);}
.panel{display:none;}
.panel.on{display:block;}

/* INPUTS */
textarea,input[type=text],input[type=date],select{width:100%;background:var(--bg1);border:1px solid var(--border2);border-radius:10px;padding:12px 14px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:13px;line-height:1.6;resize:none;transition:border-color .2s,box-shadow .2s;-webkit-appearance:none;margin-bottom:10px;}
textarea:focus,input:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--ag);}
textarea::placeholder,input::placeholder{color:var(--text3);}

/* BUTTONS */
.btn{width:100%;padding:15px;border-radius:12px;border:none;background:var(--accent2);color:#0a0a0a;font-family:'Syne',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;margin-top:2px;}
.btn:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(255,255,255,0.12);}
.btn:active{transform:translateY(0);}
.btn:disabled{opacity:.45;cursor:not-allowed;transform:none;box-shadow:none;}

/* AI RESULT */
.res{background:var(--bg1);border:1px solid var(--border2);border-radius:16px;padding:18px;margin-top:14px;display:none;animation:up .35s ease;}
.res.on{display:block;}
.rh{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap;}
.badge{font-family:'JetBrains Mono',monospace;font-size:9px;padding:3px 7px;border-radius:4px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);color:var(--accent2);}
.iabtn.on{border-color:var(--accent2);color:var(--accent2);background:var(--ag);}
.rlbl{font-size:12px;font-weight:600;color:var(--text2);}
.rtxt{font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.85;color:var(--text);white-space:pre-wrap;word-break:break-word;}
.svbtn{margin-left:auto;padding:4px 11px;border-radius:99px;border:1px solid rgba(255,255,255,0.25);background:rgba(255,255,255,0.06);color:var(--accent2);font-family:'Syne',sans-serif;font-size:10px;font-weight:700;cursor:pointer;transition:all .2s;}
.svbtn:hover{background:var(--accent2);color:#0a0a0a;}

/* LOADING */
.dots{display:inline-flex;gap:4px;align-items:center;}
.dots i{display:block;width:5px;height:5px;border-radius:50%;background:var(--accent2);animation:db 1.2s infinite ease-in-out;}
.dots i:nth-child(2){animation-delay:.2s;}.dots i:nth-child(3){animation-delay:.4s;}
@keyframes db{0%,80%,100%{transform:scale(.7);opacity:.4;}40%{transform:scale(1);opacity:1;}}

/* AGENDA */
.add-row{display:flex;gap:8px;margin-bottom:14px;}
.add-row input{flex:1;margin-bottom:0;}
.plus{padding:0 16px;border-radius:10px;border:1px solid var(--accent);background:var(--ag);color:var(--accent2);font-size:22px;cursor:pointer;transition:all .2s;flex-shrink:0;display:flex;align-items:center;}
.plus:hover{background:var(--accent);color:#fff;}
.form-card{background:var(--bg1);border:1px solid var(--border2);border-radius:16px;padding:16px;margin-bottom:14px;display:none;animation:up .3s ease;}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}

.agi{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:8px;animation:up .25s ease;}
.agi.done{opacity:.35;}
.agi.done .agt{text-decoration:line-through;}
.chk{width:20px;height:20px;border-radius:6px;border:1.5px solid var(--border2);background:transparent;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;flex-shrink:0;color:transparent;font-size:11px;}
.chk.on{background:var(--accent2);border-color:var(--accent2);color:#0a0a0a;box-shadow:none;}
.aginfo{flex:1;min-width:0;}
.agm{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);}
.agt{font-size:14px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.agd{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text2);}
.del{width:22px;height:22px;border-radius:6px;border:none;background:transparent;color:var(--text3);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;}
.del:hover{background:rgba(240,90,110,.15);color:var(--red);}

/* FICHES */
.fc{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:18px;margin-bottom:10px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;}
.fc::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;}
.fc.cb::before{background:#ffffff;}
.fc.cg::before{background:#aaaaaa;}
.fc.co::before{background:#777777;}
.fc.cr::before{background:#dddddd;}
.fc:hover{border-color:var(--border2);transform:translateY(-2px);box-shadow:0 8px 28px rgba(0,0,0,.35);}
.ftg{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);margin-bottom:5px;}
.ftt{font-size:16px;font-weight:700;margin-bottom:7px;}
.fpv{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text2);line-height:1.6;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.fft{display:flex;justify-content:space-between;align-items:center;margin-top:10px;}
.fdt{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);}

/* BOTTOM NAV */
.nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;height:var(--nav);background:rgba(8,8,16,.96);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-around;padding:0 8px 8px;z-index:200;}
.nb{display:flex;flex-direction:column;align-items:center;gap:3px;background:none;border:none;cursor:pointer;padding:8px 18px;border-radius:12px;transition:all .2s;min-width:64px;}
.nb svg{width:22px;height:22px;stroke:var(--text3);fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;transition:stroke .2s;}
.nb span{font-family:'Syne',sans-serif;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);transition:color .2s;}
.nb.on svg{stroke:var(--accent2);}
.nb.on span{color:var(--accent2);}
.nb:hover:not(.on) svg{stroke:#888888;}
.nb:hover:not(.on) span{color:#888888;}

/* MODALS */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);z-index:500;display:none;align-items:flex-end;justify-content:center;padding:16px;}
.ov.on{display:flex;animation:fi .2s ease;}
.ov.cx{align-items:center;}
@keyframes fi{from{opacity:0;}to{opacity:1;}}
.modal{background:var(--bg1);border:1px solid var(--border2);border-radius:20px 20px 14px 14px;width:100%;max-width:414px;max-height:82vh;overflow-y:auto;padding:22px 20px;animation:su .3s cubic-bezier(.34,1.56,.64,1);position:relative;scrollbar-width:none;}
.modal::-webkit-scrollbar{display:none;}
.modal.cx{border-radius:20px;max-height:90vh;}
@keyframes su{from{transform:translateY(36px);opacity:0;}to{transform:translateY(0);opacity:1;}}
.handle{width:36px;height:3px;background:var(--border2);border-radius:2px;margin:0 auto 18px;}
.mtit{font-size:19px;font-weight:800;margin-bottom:14px;}
.mbody{font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.9;color:var(--text);white-space:pre-wrap;word-break:break-word;}
.mcl{position:absolute;top:18px;right:18px;width:30px;height:30px;border-radius:50%;border:1px solid var(--border2);background:var(--card);color:var(--text2);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.mcl:hover{background:var(--bg2);color:var(--text);}

/* API modal */
.alogo{font-size:28px;font-weight:800;color:var(--accent2);margin-bottom:8px;}
.adesc{font-size:12px;color:var(--text2);line-height:1.7;margin-bottom:20px;}
.adesc a{color:var(--accent2);text-decoration:none;}

/* EMPTY */
.empty{text-align:center;padding:36px 16px;color:var(--text3);}
.eico{font-size:36px;margin-bottom:10px;}
.etxt{font-size:13px;}
</style>
</head>
<body>

<!-- API MODAL -->
<div class="ov cx on" id="apiOv">
  <div class="modal cx" style="max-width:380px;">
    <div class="alogo">Studix ‚ú¶</div>
    <p class="adesc">Entre ta cl√© API Anthropic pour activer l'IA.<br><a href="https://console.anthropic.com" target="_blank">‚Üí Obtenir une cl√© gratuite</a></p>
    <label class="lbl2">Cl√© API Anthropic</label>
    <input type="text" id="apiIn" placeholder="sk-ant-api03-...">
    <button class="btn" onclick="saveKey()">Activer l'IA ‚ú¶</button>
    <p style="font-size:10px;color:var(--text3);margin-top:10px;text-align:center;">Stock√©e uniquement sur ton appareil</p>
  </div>
</div>

<!-- FICHE MODAL -->
<div class="ov" id="ficOv">
  <div class="modal">
    <div class="handle"></div>
    <button class="mcl" onclick="closeOv('ficOv')">‚úï</button>
    <div class="mtit" id="fMtit"></div>
    <div class="mbody" id="fMbody"></div>
  </div>
</div>

<div class="app">
  <div class="hdr">
    <div class="logo">Studix ‚ú¶</div>
    <button class="iabtn" id="iaPill" onclick="openApi()">‚ö° Config IA</button>
  </div>

  <div class="scroll" id="scroll">

    <!-- HOME -->
    <div class="pg on" id="pg-home">
      <div class="greet" id="greetEl">Bonsoir,<br><span>√âtudiant¬∑e</span> üëæ</div>
      <div class="gdate" id="gDate"></div>
      <div class="stats">
        <div class="sc"><div class="sn" id="s1">0</div><div class="sl">Devoirs</div></div>
        <div class="sc"><div class="sn" id="s2">0</div><div class="sl">Fiches</div></div>
        <div class="sc"><div class="sn" id="s3">0%</div><div class="sl">Fait</div></div>
      </div>
      <div class="lbl">Prochains devoirs</div>
      <div class="card" id="homeList"><div class="empty"><div class="eico">üéâ</div><div class="etxt">Tout est √† jour !</div></div></div>
    </div>

    <!-- IA -->
    <div class="pg" id="pg-ia">
      <div class="iah">Assistant IA <span style="color:var(--text2)">‚ú¶</span></div>
      <div class="ias">Powered by Claude ¬∑ Anthropic</div>
      <div class="tabs">
        <button class="tab on" onclick="swTab('exp',this)">üß© Expliquer</button>
        <button class="tab" onclick="swTab('cor',this)">‚úÖ Corriger</button>
        <button class="tab" onclick="swTab('res',this)">‚ö° R√©sumer</button>
        <button class="tab" onclick="swTab('fic',this)">üìã Fiche</button>
      </div>

      <div class="panel on" id="p-exp">
        <label class="lbl2">Mati√®re</label>
        <input type="text" id="e-mat" placeholder="ex: Maths, Physique...">
        <label class="lbl2">Exercice / Question</label>
        <textarea id="e-exo" rows="5" placeholder="D√©cris l'exercice ou ce que tu ne comprends pas..."></textarea>
        <button class="btn" id="b-exp" onclick="callAI('exp')">üß© Expliquer pas-√†-pas</button>
        <div class="res" id="r-exp"><div class="rh"><span class="badge">CLAUDE</span><span class="rlbl">Explication pas-√†-pas</span></div><div class="rtxt" id="t-exp"></div></div>
      </div>

      <div class="panel" id="p-cor">
        <label class="lbl2">Ta r√©ponse</label>
        <textarea id="c-rep" rows="4" placeholder="√âcris ta r√©ponse ici..."></textarea>
        <label class="lbl2">Question originale</label>
        <textarea id="c-q" rows="3" placeholder="Quelle √©tait la question ?"></textarea>
        <button class="btn" id="b-cor" onclick="callAI('cor')">‚úÖ Corriger & Feedback</button>
        <div class="res" id="r-cor"><div class="rh"><span class="badge">CLAUDE</span><span class="rlbl">Correction & Feedback</span></div><div class="rtxt" id="t-cor"></div></div>
      </div>

      <div class="panel" id="p-res">
        <label class="lbl2">Cours √† r√©sumer</label>
        <textarea id="r-crs" rows="8" placeholder="Colle ton cours ici..."></textarea>
        <button class="btn" id="b-res" onclick="callAI('res')">‚ö° R√©sumer en 1 phrase</button>
        <div class="res" id="r-res"><div class="rh"><span class="badge">CLAUDE</span><span class="rlbl">R√©sum√©</span></div><div class="rtxt" id="t-res"></div></div>
      </div>

      <div class="panel" id="p-fic">
        <label class="lbl2">Mati√®re</label>
        <input type="text" id="f-mat" placeholder="ex: Histoire, Chimie...">
        <label class="lbl2">Sujet / Chapitre</label>
        <input type="text" id="f-suj" placeholder="ex: La R√©volution Fran√ßaise...">
        <label class="lbl2">Contenu source (optionnel)</label>
        <textarea id="f-cnt" rows="4" placeholder="Cours ou notes..."></textarea>
        <button class="btn" id="b-fic" onclick="callAI('fic')">üìã G√©n√©rer la fiche</button>
        <div class="res" id="r-fic">
          <div class="rh"><span class="badge">CLAUDE</span><span class="rlbl">Fiche de r√©vision</span><button class="svbtn" id="svBtn" onclick="saveFic()">üíæ Sauvegarder</button></div>
          <div class="rtxt" id="t-fic"></div>
        </div>
      </div>
    </div>

    <!-- AGENDA -->
    <div class="pg" id="pg-agenda">
      <div style="font-size:24px;font-weight:800;letter-spacing:-1px;margin-bottom:18px;">Agenda</div>
      <div class="add-row">
        <input type="text" id="agIn" placeholder="Ajouter un devoir..." onkeydown="if(event.key==='Enter')showForm()">
        <button class="plus" onclick="showForm()">+</button>
      </div>
      <div class="form-card" id="agForm">
        <label class="lbl2">Mati√®re</label>
        <input type="text" id="fm2" placeholder="Math√©matiques...">
        <div class="fgrid">
          <div><label class="lbl2">Date limite</label><input type="date" id="fd"></div>
          <div><label class="lbl2">Priorit√©</label>
            <select id="fp">
              <option value="r">üî¥ Urgent</option>
              <option value="o" selected>üü† Normal</option>
              <option value="g">üü¢ Faible</option>
              <option value="b">üîµ Projet</option>
            </select>
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:4px;">
          <button class="btn" style="flex:1;" onclick="addD()">Ajouter</button>
          <button onclick="hideForm()" style="flex:1;padding:15px;border-radius:12px;border:1px solid var(--border2);background:transparent;color:var(--text2);font-family:'Syne',sans-serif;font-size:14px;font-weight:600;cursor:pointer;">Annuler</button>
        </div>
      </div>
      <div id="agList"><div class="empty"><div class="eico">‚úèÔ∏è</div><div class="etxt">Aucun devoir</div></div></div>
    </div>

    <!-- FICHES -->
    <div class="pg" id="pg-fiches">
      <div style="font-size:24px;font-weight:800;letter-spacing:-1px;margin-bottom:18px;">Mes Fiches</div>
      <div id="ficList"><div class="empty"><div class="eico">üìã</div><div class="etxt">G√©n√®re tes premi√®res fiches depuis l'IA</div></div></div>
    </div>

  </div>

  <!-- BOTTOM NAV -->
  <nav class="nav">
    <button class="nb on" onclick="go('home',this)">
      <svg viewBox="0 0 24 24"><path d="M3 9.5L12 3l9 6.5V20a1 1 0 01-1 1H5a1 1 0 01-1-1V9.5z"/><path d="M9 21V12h6v9"/></svg>
      <span>Accueil</span>
    </button>
    <button class="nb" onclick="go('ia',this)">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 2v3M12 19v3M2 12h3M19 12h3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12"/></svg>
      <span>IA</span>
    </button>
    <button class="nb" onclick="go('agenda',this)">
      <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
      <span>Agenda</span>
    </button>
    <button class="nb" onclick="go('fiches',this)">
      <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      <span>Fiches</span>
    </button>
  </nav>
</div>

<script>
let KEY=localStorage.getItem('sx_k')||'';
let devoirs=JSON.parse(localStorage.getItem('sx_d')||'[]');
let fiches=JSON.parse(localStorage.getItem('sx_f')||'[]');
let lastFic=null, pendTxt='';
const PC={r:'dr',o:'do',g:'dg',b:'db'};
const COLS=['cb','cg','co','cr'];
const LBLS={exp:'üß© Expliquer pas-√†-pas',cor:'‚úÖ Corriger & Feedback',res:'‚ö° R√©sumer en 1 phrase',fic:'üìã G√©n√©rer la fiche'};

function init(){
  const n=new Date(),h=n.getHours();
  const gr=h<12?'Bonjour':h<18?'Bon apr√®s-midi':'Bonsoir';
  const ic=h<12?'‚òÄÔ∏è':h<18?'‚ö°':'üëæ';
  document.getElementById('greetEl').innerHTML=`${gr},<br><span>√âtudiant¬∑e</span> ${ic}`;
  const D=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
  const M=['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'];
  document.getElementById('gDate').textContent=`${D[n.getDay()]} ${n.getDate()} ${M[n.getMonth()]} ${n.getFullYear()}`;
  document.getElementById('fd').min=n.toISOString().split('T')[0];
  updatePill();
  renderAll();
  if(!KEY) setTimeout(()=>document.getElementById('apiOv').classList.add('on'),500);
  else document.getElementById('apiOv').classList.remove('on');
}

function saveKey(){
  const k=document.getElementById('apiIn').value.trim();
  if(!k.startsWith('sk-ant')){alert('Cl√© invalide !');return;}
  KEY=k;localStorage.setItem('sx_k',k);
  closeOv('apiOv');updatePill();
}
function updatePill(){
  const p=document.getElementById('iaPill');
  p.textContent=KEY?'‚óè IA activ√©e':'‚ö° Config IA';
  p.className='iabtn'+(KEY?' on':'');
}
function openApi(){document.getElementById('apiIn').value=KEY;document.getElementById('apiOv').classList.add('on');}
function closeOv(id){document.getElementById(id).classList.remove('on');}

function go(name,btn){
  document.querySelectorAll('.pg').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.nb').forEach(b=>b.classList.remove('on'));
  document.getElementById('pg-'+name).classList.add('on');
  btn.classList.add('on');
  document.getElementById('scroll').scrollTop=0;
}

function swTab(name,btn){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('on'));
  document.getElementById('p-'+name).classList.add('on');
  btn.classList.add('on');
}

function getPrompt(type){
  if(type==='exp'){
    const m=document.getElementById('e-mat').value,e=document.getElementById('e-exo').value;
    if(!e.trim())throw'D√©cris l\'exercice !';
    return`Tu es un professeur bienveillant. Explique cet exercice de ${m||'cours'} √©tape par √©tape avec des emojis num√©rot√©s. Termine par un conseil m√©mo.\n\nExercice :\n${e}`;
  }
  if(type==='cor'){
    const r=document.getElementById('c-rep').value,q=document.getElementById('c-q').value;
    if(!r.trim())throw'√âcris ta r√©ponse !';
    return`Corrige cette r√©ponse. Utilise ‚úÖ pour ce qui est bien, ‚ùå pour les erreurs, üí° pour les am√©liorations. Note /20.\n\nQuestion : ${q||'(non pr√©cis√©e)'}\nR√©ponse : ${r}`;
  }
  if(type==='res'){
    const c=document.getElementById('r-crs').value;
    if(!c.trim())throw'Colle ton cours !';
    return`R√©sume ce cours en 2 parties :\n1. UNE phrase cl√© (commence par "üí° En r√©sum√© :")\n2. Les 5 points essentiels (un emoji par point)\n\nCours :\n${c}`;
  }
  if(type==='fic'){
    const m=document.getElementById('f-mat').value,s=document.getElementById('f-suj').value,c=document.getElementById('f-cnt').value;
    if(!s.trim())throw'Indique le sujet !';
    return`G√©n√®re une fiche de r√©vision compl√®te sur : ${s} (${m||'cours'}).\n${c?'Bas√© sur :\n'+c:''}\n\nStructure : üìå D√©finition, üß† Concepts cl√©s, üìê Formules/Dates, üí° Astuce m√©mo, ‚ùì Question d'exam type + r√©ponse courte.`;
  }
}

async function callAI(type){
  if(!KEY){openApi();return;}
  let prompt;
  try{prompt=getPrompt(type);}catch(e){alert(e);return;}
  const btn=document.getElementById('b-'+type);
  const res=document.getElementById('r-'+type);
  const txt=document.getElementById('t-'+type);
  btn.disabled=true;
  btn.innerHTML='<span class="dots"><i></i><i></i><i></i></span>';
  res.classList.remove('on');txt.textContent='';
  try{
    const resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':KEY,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1200,messages:[{role:'user',content:prompt}]})
    });
    if(!resp.ok){const e=await resp.json();throw new Error(e.error?.message||'Erreur API');}
    const data=await resp.json();
    const text=data.content[0].text;
    res.classList.add('on');
    await typeText(txt,text);
    if(type==='fic') lastFic={mat:document.getElementById('f-mat').value,suj:document.getElementById('f-suj').value,txt:text};
  }catch(e){
    res.classList.add('on');
    txt.textContent='‚ùå '+e.message+'\n\nV√©rifie ta cl√© API.';
  }
  btn.disabled=false;btn.innerHTML=LBLS[type];
}

function typeText(el,text){
  return new Promise(r=>{
    let i=0;
    const iv=setInterval(()=>{
      if(i<text.length){el.textContent=text.substring(0,++i);}
      else{clearInterval(iv);r();}
    },7);
  });
}

function saveFic(){
  if(!lastFic)return;
  fiches.unshift({id:Date.now(),mat:lastFic.mat||'Cours',tit:lastFic.suj,txt:lastFic.txt,col:COLS[fiches.length%4],dt:new Date().toLocaleDateString('fr-FR')});
  localStorage.setItem('sx_f',JSON.stringify(fiches));
  renderFiches();updateStats();
  const b=document.getElementById('svBtn');
  b.textContent='‚úÖ Sauvegard√©e';
  setTimeout(()=>b.textContent='üíæ Sauvegarder',2000);
}

// AGENDA
function showForm(){
  pendTxt=document.getElementById('agIn').value;
  document.getElementById('agForm').style.display='block';
  document.getElementById('agIn').value='';
  document.getElementById('fm2').focus();
}
function hideForm(){document.getElementById('agForm').style.display='none';}

function addD(){
  const tit=pendTxt||document.getElementById('agIn').value.trim()||'Devoir';
  const mat=document.getElementById('fm2').value||'G√©n√©ral';
  const dt=document.getElementById('fd').value;
  const pr=document.getElementById('fp').value;
  devoirs.push({id:Date.now(),tit,mat,dt,pr,done:false});
  localStorage.setItem('sx_d',JSON.stringify(devoirs));
  hideForm();
  document.getElementById('fm2').value='';
  document.getElementById('fd').value='';
  pendTxt='';renderAll();
}

function togD(id){
  const d=devoirs.find(x=>x.id===id);
  if(d)d.done=!d.done;
  localStorage.setItem('sx_d',JSON.stringify(devoirs));
  renderAll();
}

function delD(id){
  devoirs=devoirs.filter(x=>x.id!==id);
  localStorage.setItem('sx_d',JSON.stringify(devoirs));
  renderAll();
}

function openDIA(id){
  const d=devoirs.find(x=>x.id===id);if(!d)return;
  go('ia',document.querySelectorAll('.nb')[1]);
  document.getElementById('e-mat').value=d.mat;
  document.getElementById('e-exo').value=d.tit;
  swTab('exp',document.querySelector('.tab'));
}

function renderAgenda(){
  const l=document.getElementById('agList');
  if(!devoirs.length){l.innerHTML='<div class="empty"><div class="eico">‚úèÔ∏è</div><div class="etxt">Aucun devoir</div></div>';return;}
  l.innerHTML=devoirs.map(d=>{
    const ds=d.dt?new Date(d.dt+'T12:00').toLocaleDateString('fr-FR',{day:'numeric',month:'short'}):'';
    return`<div class="agi${d.done?' done':''}">
      <button class="chk${d.done?' on':''}" onclick="togD(${d.id})">${d.done?'‚úì':''}</button>
      <div class="aginfo">
        <div class="agm">${d.mat}</div>
        <div class="agt">${d.tit}</div>
        ${ds?`<div class="agd">${ds}</div>`:''}
      </div>
      <div style="display:flex;gap:6px;align-items:center;flex-shrink:0;">
        <div class="dot ${PC[d.pr]}"></div>
        <button class="iab" onclick="openDIA(${d.id})">IA ‚ú¶</button>
        <button class="del" onclick="delD(${d.id})">‚úï</button>
      </div>
    </div>`;
  }).join('');
}

function renderHome(){
  const up=devoirs.filter(d=>!d.done).slice(0,5);
  const l=document.getElementById('homeList');
  if(!up.length){l.innerHTML='<div class="empty"><div class="eico">üéâ</div><div class="etxt">Tout est √† jour !</div></div>';return;}
  l.innerHTML=up.map(d=>{
    const ds=d.dt?new Date(d.dt+'T12:00').toLocaleDateString('fr-FR',{day:'numeric',month:'short'}):'Sans date';
    return`<div class="drow">
      <div class="dot ${PC[d.pr]}"></div>
      <div class="di"><div class="dm">${d.mat}</div><div class="dt">${d.tit}</div><div class="dd">‚Üí ${ds}</div></div>
      <button class="iab" onclick="openDIA(${d.id})">IA ‚ú¶</button>
    </div>`;
  }).join('');
}

function updateStats(){
  document.getElementById('s1').textContent=devoirs.filter(d=>!d.done).length;
  document.getElementById('s2').textContent=fiches.length;
  const p=devoirs.length?Math.round(devoirs.filter(d=>d.done).length/devoirs.length*100):0;
  document.getElementById('s3').textContent=p+'%';
}

function renderFiches(){
  const l=document.getElementById('ficList');
  if(!fiches.length){l.innerHTML='<div class="empty"><div class="eico">üìã</div><div class="etxt">G√©n√®re tes premi√®res fiches depuis l\'IA</div></div>';return;}
  l.innerHTML=fiches.map(f=>`
    <div class="fc ${f.col}" onclick="openFic(${f.id})">
      <div class="ftg">${f.mat}</div>
      <div class="ftt">${f.tit}</div>
      <div class="fpv">${f.txt}</div>
      <div class="fft">
        <div class="fdt">${f.dt}</div>
        <button onclick="event.stopPropagation();delFic(${f.id})" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:12px;padding:4px 8px;border-radius:6px;transition:color .2s;" onmouseover="this.style.color='var(--red)'" onmouseout="this.style.color='var(--text3)'">‚úï</button>
      </div>
    </div>`).join('');
}

function openFic(id){
  const f=fiches.find(x=>x.id===id);if(!f)return;
  document.getElementById('fMtit').textContent=f.tit;
  document.getElementById('fMbody').textContent=f.txt;
  document.getElementById('ficOv').classList.add('on');
}
function delFic(id){
  fiches=fiches.filter(x=>x.id!==id);
  localStorage.setItem('sx_f',JSON.stringify(fiches));
  renderFiches();updateStats();
}

function renderAll(){renderHome();renderAgenda();renderFiches();updateStats();}

document.getElementById('ficOv').addEventListener('click',function(e){if(e.target===this)closeOv('ficOv');});
document.getElementById('apiOv').addEventListener('click',function(e){if(e.target===this&&KEY)closeOv('apiOv');});

if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});
init();
</script>
</body>
</html>
